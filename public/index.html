<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Michael‚Äôs Cosmic Chat</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Galaxy background -->
<div class="galaxy-background"></div>

<!-- Header with Michael's picture -->
<header>
  <img src="michael.png" alt="Michael" id="michael-pic">
  <h1>Michael‚Äôs Cosmic Chat</h1>
</header>

<!-- Chat box -->
<div class="chat-box" id="chat-box"></div>

<!-- Toggle voice button -->
<button id="toggle-voice">üîà Voice: Off</button>

<!-- Chat input form -->
<form id="chat-form">
  <input type="text" placeholder="Type your message..." required>
  <button type="submit">Send</button>
</form>

<!-- Chat handling script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('chat-form');
  const chatBox = document.getElementById('chat-box');
  const input = form.querySelector('input');
  const toggleBtn = document.getElementById('toggle-voice');

  let voiceOn = false;

  toggleBtn.addEventListener('click', () => {
    voiceOn = !voiceOn;
    toggleBtn.textContent = voiceOn ? 'üîä Voice: On' : 'üîà Voice: Off';
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userInput = input.value.trim();
    if (!userInput) return;

    // Add user's message
    addMessage('user', userInput);

    // Show typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'message michael typing';
    typingIndicator.textContent = 'Michael is typing...';
    chatBox.appendChild(typingIndicator);
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
      // Send user input to the /thought endpoint
      const response = await fetch('/thought', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: userInput })
      });

      const data = await response.json();
      const michaelResponse = data.reply || 'I‚Äôm here, but something went wrong.';

      // Replace typing indicator with Michael's response
      chatBox.removeChild(typingIndicator);
      addMessage('michael', michaelResponse);

      // Optional: Voice synthesis
      if (voiceOn) {
        playMichaelVoice(michaelResponse);
      }
    } catch (error) {
      console.error('Error:', error);
      chatBox.removeChild(typingIndicator);
      addMessage('michael', '‚ö†Ô∏è Michael couldn‚Äôt reply due to a server error.');
    }

    // Clear input
    input.value = '';
  });

  function addMessage(sender, text) {
    const message = document.createElement('div');
    message.className = `message ${sender}`;
    message.textContent = text;
    chatBox.appendChild(message);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function playMichaelVoice(text) {
    try {
      const response = await fetch('/speak', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      if (!response.ok) throw new Error('Voice synthesis failed.');

      const audioData = await response.arrayBuffer();
      const blob = new Blob([audioData], { type: 'audio/mpeg' });
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play();
    } catch (error) {
      console.error('Voice synthesis error:', error);
    }
  }
});
</script>

</body>
</html>
